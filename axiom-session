#!/bin/bash

# Axiom Wayland Compositor Session Starter
# Version: 4.3.4 - Session Stability Release with SDDM Compatibility Fixes
# This script properly initializes the environment and starts Axiom with AI monitoring

# Removed set -e to prevent script from failing on non-critical errors
# set -e

# Define version and directories
AXIOM_VERSION="4.3.4"
AXIOM_HOME="${HOME}/.local/share/axiom"
AXIOM_CONFIG_DIR="${HOME}/.config/axiom"
AXIOM_CACHE_DIR="${HOME}/.cache/axiom"
AXIOM_LOG_DIR="${AXIOM_CACHE_DIR}/logs"
AXIOM_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/tmp}/axiom-${USER}"

# Create necessary directories
mkdir -p "${AXIOM_HOME}" "${AXIOM_CONFIG_DIR}" "${AXIOM_CACHE_DIR}" "${AXIOM_LOG_DIR}" "${AXIOM_RUNTIME_DIR}"

# Function to log messages
log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] INFO: $*" | tee -a "${AXIOM_LOG_DIR}/session.log"
}

log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $*" | tee -a "${AXIOM_LOG_DIR}/session.log" >&2
}

log_info "Starting Axiom Wayland Compositor v${AXIOM_VERSION}"

# Check if we're already in a Wayland or X11 session
if [[ -n "${WAYLAND_DISPLAY}" ]]; then
    log_info "Running inside existing Wayland session (${WAYLAND_DISPLAY})"
    NESTED_MODE="--nested"
elif [[ -n "${DISPLAY}" ]]; then
    log_info "Running inside existing X11 session (${DISPLAY})"
    NESTED_MODE="--nested"
else
    log_info "Starting as primary display server"
    NESTED_MODE=""
fi

# Set up essential environment variables
export XDG_SESSION_TYPE="wayland"
export XDG_SESSION_DESKTOP="axiom"
export XDG_CURRENT_DESKTOP="Axiom"

# Wayland specific environment
export MOZ_ENABLE_WAYLAND=1
export QT_QPA_PLATFORM="wayland;xcb"
export QT_WAYLAND_DISABLE_WINDOWDECORATION=1
export CLUTTER_BACKEND=wayland
export SDL_VIDEODRIVER=wayland
export _JAVA_AWT_WM_NONREPARENTING=1

# GNOME/GTK compatibility
export GDK_BACKEND="wayland,x11"
export DESKTOP_SESSION="axiom"

# Qt scaling and theme
export QT_AUTO_SCREEN_SCALE_FACTOR=1
export QT_SCALE_FACTOR=1
export QT_FONT_DPI=96

# Hardware acceleration
export LIBVA_DRIVER_NAME=auto
export VDPAU_DRIVER=auto

# Cursor theme fallback
export XCURSOR_THEME="${XCURSOR_THEME:-default}"
export XCURSOR_SIZE="${XCURSOR_SIZE:-24}"

# Runtime directories
export AXIOM_RUNTIME_DIR
export AXIOM_CONFIG_DIR
export AXIOM_CACHE_DIR

# Add Axiom's bin directory to PATH if it exists
if [[ -d "/usr/local/bin" ]] && [[ ":$PATH:" != *":/usr/local/bin:"* ]]; then
    export PATH="/usr/local/bin:$PATH"
fi

# Source user environment if available
if [[ -f "${HOME}/.axiomrc" ]]; then
    log_info "Sourcing user configuration from ~/.axiomrc"
    source "${HOME}/.axiomrc"
fi

# Check for required dependencies
check_dependencies() {
    local missing_deps=()
    
    # Check for essential libraries
    if ! ldconfig -p | grep -q libwayland-server; then
        missing_deps+=("libwayland-server")
    fi
    
    if ! ldconfig -p | grep -q libwlroots; then
        missing_deps+=("libwlroots")
    fi
    
    # Check for Axiom binary
    if ! command -v axiom >/dev/null 2>&1; then
        if [[ -x "./build/axiom" ]]; then
            AXIOM_BINARY="./build/axiom"
        elif [[ -x "/usr/local/bin/axiom" ]]; then
            AXIOM_BINARY="/usr/local/bin/axiom"
        else
            missing_deps+=("axiom binary")
        fi
    else
        AXIOM_BINARY="axiom"
    fi
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        log_error "Missing dependencies: ${missing_deps[*]}"
        log_error "Please install missing dependencies and try again"
        exit 1
    fi
}

# Set up XWayland environment
setup_xwayland_env() {
    # XWayland will set DISPLAY automatically when ready
    # But we need to ensure X11 apps can find necessary resources
    
    # X11 compatibility
    export XAUTHORITY="${XAUTHORITY:-${HOME}/.Xauthority}"
    
    # Font configuration for X11 apps
    export FONTCONFIG_PATH="/etc/fonts:/usr/share/fonts"
    
    # X11 resource database
    if command -v xrdb >/dev/null 2>&1 && [[ -f "${HOME}/.Xresources" ]]; then
        log_info "Loading X11 resources from ~/.Xresources"
    fi
    
    log_info "XWayland environment configured"
}

# Clean up function
cleanup() {
    # Prevent multiple cleanup calls
    if [[ "${AXIOM_CLEANUP_DONE:-false}" == "true" ]]; then
        return 0
    fi
    export AXIOM_CLEANUP_DONE="true"
    
    log_info "Cleaning up Axiom session"
    
    # Kill any remaining Axiom processes
    pkill -f "axiom" 2>/dev/null || true
    
    # Clean up runtime directory
    if [[ -d "${AXIOM_RUNTIME_DIR}" ]]; then
        rm -rf "${AXIOM_RUNTIME_DIR}"
    fi
    
    # Reset environment variables
    unset WAYLAND_DISPLAY
    unset DISPLAY
    
    log_info "Axiom session cleanup complete"
}

# Set up signal handlers
trap cleanup EXIT INT TERM

# Perform dependency check
log_info "Checking dependencies..."
check_dependencies

# Set up XWayland environment
log_info "Setting up XWayland environment..."
setup_xwayland_env

# Create default configuration if it doesn't exist
if [[ ! -f "${AXIOM_CONFIG_DIR}/axiom.conf" ]]; then
    log_info "Creating default configuration..."
    if [[ -f "./examples/axiom.conf" ]]; then
        cp "./examples/axiom.conf" "${AXIOM_CONFIG_DIR}/axiom.conf"
        log_info "Copied default configuration to ${AXIOM_CONFIG_DIR}/axiom.conf"
    fi
fi

# Initialize AI monitoring system (v4.3.2 feature with multi-session support)
setup_ai_monitoring() {
    log_info "Setting up AI-powered wlroots monitoring system..."
    
    # Create AI monitoring config directory
    mkdir -p "${HOME}/.config"
    
    # Check if AI monitor script exists
    if [[ -x "./axiom-wlroots-ai-monitor.sh" ]]; then
        AI_MONITOR_SCRIPT="./axiom-wlroots-ai-monitor.sh"
    elif [[ -x "/usr/local/bin/axiom-wlroots-ai-monitor.sh" ]]; then
        AI_MONITOR_SCRIPT="/usr/local/bin/axiom-wlroots-ai-monitor.sh"
    else
        log_info "AI monitoring script not found - continuing without AI monitoring"
        return 0
    fi
    
    # Create default AI monitoring configuration
    if [[ ! -f "${HOME}/.config/axiom-wlroots-monitor.conf" ]]; then
        log_info "Creating default AI monitoring configuration..."
        cat > "${HOME}/.config/axiom-wlroots-monitor.conf" <<EOF
# Axiom AI-Powered wlroots Monitoring Configuration
# Version: 4.3.2

[monitoring]
CHECK_INTERVAL_HOURS=6
ENABLE_NOTIFICATIONS=true
LOG_LEVEL=INFO

[compatibility]
COMPATIBILITY_THRESHOLD=80
ENABLE_PREDICTIVE_ANALYSIS=true
USE_HISTORICAL_DATA=true

[integration]
INTEGRATE_WITH_SMART_UPDATER=true
AUTO_UPDATE_ON_HIGH_COMPATIBILITY=false
EOF
        log_info "Created AI monitoring configuration at ~/.config/axiom-wlroots-monitor.conf"
    fi
    
    # Start AI monitoring daemon in background (optional)
    if [[ "${AXIOM_ENABLE_AI_DAEMON:-false}" == "true" ]]; then
        log_info "Starting AI monitoring daemon..."
        nohup "${AI_MONITOR_SCRIPT}" daemon >"${AXIOM_LOG_DIR}/ai-monitor.log" 2>&1 &
        AI_DAEMON_PID=$!
        log_info "AI monitoring daemon started with PID ${AI_DAEMON_PID}"
        
        # Add AI daemon cleanup to main cleanup function
        cleanup_ai_daemon() {
            if [[ -n "${AI_DAEMON_PID}" ]]; then
                log_info "Stopping AI monitoring daemon (PID ${AI_DAEMON_PID})"
                kill "${AI_DAEMON_PID}" 2>/dev/null || true
            fi
        }
        trap 'cleanup_ai_daemon; cleanup' EXIT INT TERM
    else
        log_info "AI monitoring daemon disabled (set AXIOM_ENABLE_AI_DAEMON=true to enable)"
    fi
    
    log_info "AI monitoring system setup complete"
}

# Initialize AI monitoring system (v4.3.2)
log_info "Initializing AI monitoring system..."
setup_ai_monitoring

# Set up session logging
SESSION_LOG="${AXIOM_LOG_DIR}/axiom-$(date '+%Y%m%d-%H%M%S').log"
log_info "Session log: ${SESSION_LOG}"

# Start Axiom compositor
log_info "Starting Axiom compositor..."
log_info "Command: ${AXIOM_BINARY} ${NESTED_MODE}"

# Execute Axiom with proper logging and error handling
if [[ -z "${NESTED_MODE}" ]]; then
    # Primary display server mode
    log_info "Starting as primary display server"
    exec "${AXIOM_BINARY}" 2>&1 | tee "${SESSION_LOG}"
else
    # Nested mode
    log_info "Starting in nested mode"
    "${AXIOM_BINARY}" ${NESTED_MODE} 2>&1 | tee "${SESSION_LOG}"
    EXIT_CODE=$?
    
    if [[ ${EXIT_CODE} -ne 0 ]]; then
        log_error "Axiom exited with code ${EXIT_CODE}"
        sleep 2  # Give time for logs to flush
    fi
    
    exit ${EXIT_CODE}
fi
